---
title: "Visualising"
date: "Semester 1, 2022"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_download: true
    code_folding: show
---

```{r setup, include=FALSE}
library(knitr)

knitr::opts_chunk$set(
  comment = "#>",
  fig.path = "figures/", # use only for single Rmd files
  collapse = TRUE,
  echo = TRUE
)
```

> #### Data Focus
>
> Modules and Handouts 2--6 cover topics that are part of the data analysis journey and are all interrelated. Each module will introduce new content and expand on the material covered in previous modules. For example, in Module 2 we introduce the basics of the R plotting systems. Subsequent handouts include more advanced plotting options and techniques.

\

\


Handout: [Handout 02 - Visualising Data](handout2.html)

Associated Readings:

- [R for Data Science - Chapter 12](https://r4ds.had.co.nz/tidy-data.html)
- [R for Data Science - Chapter 11](https://r4ds.had.co.nz/data-import.html)
- [R for Data Science - Chapter 3](https://r4ds.had.co.nz/data-visualisation.html)



## Tabular Data

In this module we begin to work with complete tables of data, and learn how to make informative graphs. 

We will start by getting our scientific research data into RStudio. Commonly, we first enter our data into Excel for cleaning and organising, and save it out as a csv (comma separated values) file. We then import the file into R for data analysis. We will provide the csv file to be used with this module.

When you have completed this module, you should be ready to produce the graphs and figures you will need for your in-course research projects. If you run into any problems or have any questions, email us, or drop us a message in the R4SSP class team on MS Teams.


## Preparation - Do this very carefully

Document organisation is vitally important. We suggest that you keep a separate folder for each R4SSP module. To do this, you can set up a formal RStudio project (see for example https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects). But if you don't feel quite ready for that, you can just collect your script file and data files together in a folder. Proceed as follows:


1. Launch R Studio

2. Following the procedure from **Using a Script File** in Module 1 - Intro to R and RStudio, create a script file and save it to your desktop or other location where you will be able to find it.

3. Quit R Studio

4. Locate the script file you just made (it will have a .R file suffix). 

5. Create a new folder (name it something sensible) and place the script file in it.

6. The sample csv data file used in this module is called **gapminder_data_2007.csv**. This file contains life expectancy, population and GDP values for 142 different countries. The data for each country were measured 12 times between 1952 and 2007. These data are sourced from the GapMinder foundation (https://www.gapminder.org/).

Retrieve the sample csv data file from the course Google Drive shared folder ^[https://drive.google.com/drive/folders/1ttf1s8-vkJNOlHdphfi2zFyMq6gGEvCy?usp=sharing]. Place the csv file into the folder with your script file.

7. Open the folder and double-click **on your script file** to open it in RStudio.

If you set things up this way, RStudio will be able to find your data file for the next step -- importing data.

\

## Importing a data file

The first few lines of our data file **gapminder_data_2007.csv** as it appears when opened in Excel, are shown below:

```{r fig01, fig.align='center', out.width = "50%", fig.cap = "GapMinder Data", fig.pos = "H", echo = FALSE}
include_graphics("images/gapminder_data_2007.png")
```



We will import this file into R for some preliminary data analysis.

To import a csv file into R we can use the function `read.csv`. Like the R functions we used in Module 1, `read.csv` accepts an argument between its round brackets. The argument is the name of the input file. Because the name of the file is a string, we surround it with double quotes. We will therefore say:

`read.csv("gapminder_data_2007.csv")`

\

## Import and check your data

Type the following line into your script file. Execute the command as you did in the previous module by placing the cursor anywhere on the line and typing ctrl-Enter (Windows) or cmd-Enter (Mac).

```{r read.csv}
read.csv("gapminder_data_2007.csv")
```


When imported into R, the data from the csv file are stored in an R object called a **data frame**.Data frames are simply tables, organised into rows and columns. The columns have names taken from the first row of the csv file, and each subsequent row of the csv file becomes a row in the data frame. 

When you call `read.csv`, passing in a file name, R reads in the file, converts it to a data frame, and displays it in the console. The columns have the same names as in the csv file. We will see later that we can use the column names to explore specific properties of our data set.

Our call to function `read.csv` will import the file and display its contents in the console, but this is not quite enough. We want R to store the data in a named variable so that we can refer to it later (i.e., perform analyses on it). We do that with the assignment operator, as we did in our previous module. For example, we can say:

`gapminder_data <- read.csv("gapminder_data_2007.csv")`

After storing our imported data into a variable, you should always check that your data have been imported correctly. Data entry errors can cause R to make the wrong assumptions about your data. If you have a column of numbers that contains even one accidental alphabetic character (typos do happen) R will consider the whole column to be strings. Later, R will give the wrong results when you perform statistical analyses on these data (or it will refuse to perform them at all). 

Use the following commands to visually inspect your imported data:

```{r check 1}
# Write the first few lines of a data frame to the console with function head
head(gapminder_data)


# Write the last few lines of a data frame to the console with function tail
tail(gapminder_data)
```

```{r check 2}
# Display the number of lines, the column names, and the data type of each 
# column, with function str
str(gapminder_data)
```

Each column header is associated with a data type **chr**, **int**, or **num**. These indicate what kind of data R identified in the input file. Columns that are **chr** contain strings (characters), columns that are **int** contain integers (whole numbers) and columns that are num contain numbers with a decimal part. 

You can see the same information about the structure of a data frame in the Environment panel of RStudio (upper-right of screen; Environment tab). When you successfully import a csv into a variable with `read.csv`, the resulting data frame appears in the Environment pane. Click the blue arrow beside the object to display the details of its structure.

```{r fig02, fig.align='center', out.width = "50%", fig.cap = "Data Frame in Environment Pane", fig.pos = "H", echo = FALSE}
include_graphics("images/df_in_env_pane.PNG")
```


\


## Inspecting columns of data
You will note that function `str` prefaces each column name with `$`. We use the `$` to select individual columns of data from a data frame. For example, to select just the life expectancy values from our data, we say `gapminder_data$lifeExp`. (Be sure to type the column name exactly as it appears)


## Perform descriptive analyses on columns

It is always informative to begin data analysis by inspecting your dependent variable (in this case, amount of money collected). Work through each of the following steps, adding the code to your script file (and remember to **Save Often**).

To select a single column from a data frame, we apply the **$** operator to the data frame, and specify the column name. The output is a **vector** containing the values in the named column.

```{r selectColumn}

# Select a single column with $ and the column name
puppy_donations_data$Amount
```

To simplify our later typing, we can use the assignment operator to save the output into a named variable.

```{r saveColumn}
# Save a single column into a variable
amount_only <- puppy_donations_data$Amount

# Display the variable
amount_only
```

We can now apply R's many, many statistical functions to our variable.

### Simple numeric descriptive statistics

We can compute some useful descriptive statistics using Base R built-in functions:

```{r someStats}
# Compute the mathematical mean with function mean()
mean(amount_only)

# Compute the standard deviation with function sd()
sd(amount_only)

# Get a selection of distribution descriptors with function summary()
summary(amount_only)
```

There are a variety of complex analyses that we could perform on these data using R's built-in functions, and those available additional packages and libraries. For this module, we concentrate on how we can explore our data visually with graphs.

### Simple plots - the histogram

A histogram shows the **frequency distribution** of a data set. That is, it shows counts of the  different values of the dependent variable. We can plot a histogram of the amounts collected, (ignoring the Puppy/Alone condition for now), to get a quick sense of how much people are donating. We generate this graph with function `hist`. The graph will be displayed in the Plots tab of RStudio's lower-right pane.

```{r 02-hist}
hist(amount_only)
```
Our data appear to be bimodal (i.e. they have two peaks). This pattern can indicate the presence of distinct groups in a data set, an informative result in this study. 


### Boxplots
In a later module, we will learn some efficient ways to extract group means from complex data sets. For this module, assume that we computed the average amount collected for the Puppy and Alone groups separately. We would see that the mean amount is higher for collectors who had puppies than for those who did not ($197.79 vs. $102.30). We can see  this difference clearly using a boxplot. 

The R function `boxplot` accepts two arguments. 

The first argument is the **formula**. This is a complex, yet very common, argument format for R statistical functions. The formula describes a linear model for a data set with the general structure: **dependent or predicted variable ~ independent variables or predictors**, using columns names from the data frame. The ~ (tilde) is read as "depends on" or "is predicted by". For our example, we are interested in the way that Amount is dependent on the Puppy/Alone condition, so we specify our formula as **Amount ~ Condition**.  We will see more complex examples of the formula argument later in the semester.


The second argument to boxplot is the data frame.

```{r 02-boxplot01}
boxplot(Amount ~ Condition, puppy_donations_data)
```


Boxplots efficiently illustrate both the central tendency and the variability of a data set. Each grey box extends from the first quartile to the third quartile of its input values. The dark line across the box is at the median. The two thin lines outside the qrey box show the values of the minimum and maximum scores, excluding extreme outliers. If extreme outliers are present, they are shown as small circles. This boxplot clearly shows that, in our sample, people tended to donate more when the collector had a puppy.


### Plotting with ggplot2

The ggplot2 package is a popular data visualisation package for R. It was developed by Dr. Hadley Wickham and based on a complex symbolic system called the 'Grammar of Graphics'. It contains the library **ggplot**, with which we can make a wide variety of sophisticated, publication-quality plots and figures.

The syntax of ggplot is complex, and we will concentrate on the foundations in this module. For a more detailed treatment, see the Data Visualisation chapter in the R for Data Science online text, at  https://r4ds.had.co.nz/data-visualisation.html.



# !!! STOPPED HERE





In order to use it we need to first load it into R.



```{r}
library(ggplot2)
```

ggplot tackles plotting reducing it into three components

- what is the data
- how the data is mapped to aesthetics (aes)
- how the data is represented geometrically (geom)

So to create a plot using ggplot we need to specify these three components.


Plots can then be made incrementally by adding on additional layers.

We'll now recreate the same plots as we did with the Base R plotting system.

# PH Not appropriate for this type of data set

#### Scatter plots

Here you'll see we've defined our data, we've mapped specific columns to our axes, and are using a 'point' as our geometric representation.

```{r 02-gg_point1}
ggplot(data = puppy_donations_data, mapping = aes(x = CollectorID, y = Amount)) + 
  geom_point()
```

We can also store our plots in a variable to build upon

```{r}
p <- ggplot(data = puppy_donations_data, mapping = aes(x = CollectorID, y = Amount))
```

What does `p` actually contain?
```{r 02-gg}
p
```


```{r 02-gg_point2}
p + geom_point()
```


##### Specifiying colour

Remember `p` contains our initial specification of the data and mappings

```{r 02-gg_point3}
p + geom_point(colour = 'red')
```

##### Mapping colour from our data

```{r 02-gg_point4}
p + geom_point(aes(colour = Condition))
```
Notice that we didn't specify the colour for our points, instead we have told ggplot to use colours based on the values that were found in the "Condition" column using `aes`.

\

#### Line plots

In this case, we have the same data and mapping, but we want to have the data represented by a line so we choose `geom_line` as our "geom".

```{r 02-gg_line1}
p + geom_line()
```




##### Adding layers

```{r 02-gg_line2}
p + 
  geom_line() + 
  geom_point()
```



```{r 02-gg_line3}
p + 
  geom_line(colour = 'gold') + 
  geom_point(colour = 'tomato')
```

##### Using mappings

If you would like to plot individual lines based on a categorical variable you can used a 'group' mapping:

```{r 02-gg_line4}
p + 
  geom_line(aes(group = Condition))
```


We can specify separate aesthestics for each layer

```{r 02-gg_line5}
p + 
  geom_line(aes(colour = Condition)) + 
  geom_point(aes(colour = Condition))
```

Note that colour will automatically imply a _group_.

or if it is common to all layers, we can specify them in the initial setting up:

```{r 02-gg_line6}
ggplot(data = puppy_donations_data, 
       mapping = aes(x = CollectorNumber, 
                     y = Amount, 
                     colour = Condition)) + 
  geom_line() + 
  geom_point()
```

\

#### Histogram

A histogram is created from a single continuous variable.

```{r 02-gg_hist}
ggplot(data = puppy_donations_data, aes(x = Amount)) + 
  geom_histogram()
```

\

#### Boxplot

In ggplot, to create a boxplot, we need to specify a continuous variable, and a categorical variable.

```{r 02-gg_box1}
ggplot(data = puppy_donations_data, aes(x = Condition, y = Amount)) + 
  geom_boxplot()
```

Or you could make it horizontal by switching the the x/y arguments.

```{r 02-gg_box2}
ggplot(data = puppy_donations_data, aes(x = Amount, y = Condition)) + 
  geom_boxplot()
```

\

### Customising

There are a multitude of customisations that can be done to plots such as titles, labels, colours, etc.

A fantastic resource for looking at how to customise your plots made using the Base R plotting system is the [R Graphics Cookbook](https://r-graphics.org).

#### Themes

For ggplot, the plots are made up of _elements_ and can be customised using `theme()` or by picking one of the pre-defined themes - e.g. `theme_bw()` provides a black/white theme.

The main elements are

- `element_text` for text
- `element_rect` for rectangular areas
- `element_line` for lines
- `element_blank` to remove/hide elements

```{r 02-gg_theme1}
ggplot(data = puppy_donations_data, aes(x = Condition, y = Amount)) + 
  geom_boxplot() + 
  theme(axis.title = element_text(size = 16), 
        panel.grid = element_blank(), 
        panel.background = element_rect(colour = "blue", fill = "light green"))

```



```{r 02-gg_theme2}
ggplot(data = puppy_donations_data, aes(x = Condition, y = Amount)) + 
  geom_boxplot() + 
  theme_bw()
```

There is also a fantastic cheat sheet available in RStudio under `Help` -> `Cheat Sheats` -> `Data Visualization with ggplot2`

\

\

## Conclusion

This document has presented a simple introduction to working with complete tables of data in R. We learned how to import a csv file into a data frame, how to select columns and rows of interest from the data frame, and how to perform simple, yet illustrative summaries on them. We have covered only a tiny fraction of the data analyses you can perform with R and RStudio. You can also do very complex statistics like ANOVA, regression, factor analysis, and complex modelling. The specific statistical analyses you will need to do for your in-course assignments will depend on the papers you are taking, but you can be confident that whatever your lecturers require can almost certainly by done efficiently in R. As we proceed through the semester, if you wish to discuss a particular data analysis, processing, or presentation task, please let us know.


### What's Next

Fill in the module feedback form [https://tinyurl.com/r4ssp-module-fb](https://tinyurl.com/r4ssp-module-fb).

Ensure you have the `tidyverse` package installed. Refer to Appendix 2, or [https://r4ds.had.co.nz/introduction.html](https://r4ds.had.co.nz/introduction.html) for how to do this.
 


\

\

## Appendix

### Manual Data Entry in R

For extremely small data sets, you can manually enter tabular data into R. You create a vector for each data column using the combine function `c`, and then collect those vectors into a data frame:

```{r manual data 1}
countries <- c("Austria", "Brazil", "Canada")
capitals <- c("Vienna", "Brasilia", "Ottawa")
population_in_millions <- c(9, 211, 38)

geography_df <- data.frame(Country = countries,
                           Capital = capitals,
                           PopulationMillions = population_in_millions)

geography_df
```


### Installing Packages

When R is installed, it comes with a large set of commands, data structure, and functions which are together known as **base R**. Over the years, researchers and programmer have written thousands of additional functions and modules (called **libraries**) that you can use in your own R code. This **third-party code** is checked by moderators and, if it passes inspection, loaded onto an official R server in a file structure called a **package**. To use packages, you must first download them to your computer. They are placed in the same folders where base R was originally installed. 

To access the functions in a package in your R code, you load the package using the `library` command, as we saw above with **readr**. You only need to download a package one time on any machine, but the `library` command must be executed at the start of each RStudio session (i.e. every time you launch RStudio).

To install a package, use the `install.packages` command passing the name of the package as the function argument. The name is a string **so must be surrounded by double quotes**. To use an installed package, use the `library` command, passing in the name of the package. Now that the package has been installed, R recognises it as an entity (like a variable) so you do not put double quotes around the package name in the library command.

For example, when you want to use function `read_csv`, contained in library **readr**:

```{r getting readr, eval = FALSE}

# Download the reshape2 code to your machine
install.packages("readr")


# Load the library for the current session
library(readr)
```

### Tidyverse

The tidyverse is a collection of packages (metapackage) that are an (opinionated) way of performing analysis in R and are all designed to operate nicely together. When `tidyverse` is installed it actually is a wrapper that installs the individual packages that make up the tidyverse core.

The tidyverse consists of a core set of packages to perform common tasks in data analysis and are `ggplot2` (plotting), `dplyr` (data manipulation), `tidyr` (data tidying), `readr` (data importing), `purrr` (functional programming), `tibble` (a special type of data frame), `stringr` (common tasks for string manipulations), and  `forcats` (dealing with factors)


```{r install tidyverse, eval = FALSE}
# Download and install the packages of tidyverse
install.packages("tidyverse")
```


```{r}
# load the tidyverse packages for the current session
library(tidyverse)
```

### R for Data science extra packages

If you are following along with R for Data Science make sure you have these packages installed:

- nycflights13
- gapminder
- Lahman

```{r, eval = FALSE}
install.packages(c("nycflights13", "gapminder", "Lahman"))
```





